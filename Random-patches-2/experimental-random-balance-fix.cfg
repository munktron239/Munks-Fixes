// just a whole bunch of random balance fixes for stock/dlc. i just add stuff to this patch when i notice something isn't consistent with the stock game

// =========================================================================================================================================================

// fix ordering of variants on the mk2 lander can. like, why is the rover variant placed first???
@PART[mk2LanderCabin_v2]:HAS[@MODULE[ModulePartVariants]]:FIRST
{
	@MODULE[ModulePartVariants]
	{
		!VARIANT[Rover],* {}
		!VARIANT[Lander],* {}
		VARIANT
		{
			name = Lander
			displayName = #autoLOC_900686
			primaryColor = #ffffff
			secondaryColor = #ffffff
			sizeGroup = Lander
			disabledEvents = FlagDecal.ToggleFlag
			GAMEOBJECTS
			{
				ColBot = true
				COLPod = true
				COLShell1 = true
				COLShell2 = true
				ColTop = true
				DoorLF = true
				DoorLR = true
				DoorRF = true
				DoorRR = true
				Flag = true
				InnerPod = true
				OuterPod = true
			}			
		}
		VARIANT
		{
			name = Rover
			displayName = #autoLOC_900683
			primaryColor = #aaaaaa
			secondaryColor = #ffffff
			sizeGroup = Can
			disabledAnimations = Mk2Doors
			GAMEOBJECTS
			{
				ColBot = false
				COLPod = true
				COLShell1 = false
				COLShell2 = false
				ColTop = false
				DoorLF = false
				DoorLR = false
				DoorRF = false
				DoorRR = false
				Flag = true
				InnerPod = true
				OuterPod = false
			}
		}
	}
}

// fix ordering of variants on the size2 rcs tank (the yellow variant is clearly meant to be first)
@PART[RCSTank1-2]:HAS[@MODULE[ModulePartVariants]]:NEEDS[!Restock]:FOR[MunksFixes]
{
	@MODULE[ModulePartVariants]
	{
		!VARIANT[GrayAndWhite],* {}
		!VARIANT[YellowAndWhite],* {}
		VARIANT
		{
			name = YellowAndWhite
			displayName = #autoLOC_8003114
			themeName = YellowAndWhite
			primaryColor = #ffdd00
			secondaryColor = #ffffff
			TEXTURE
			{
				mainTextureURL = Squad/Parts/FuelTank/RCSFuelTankR1/RCSFuelTankR1_02
				_BumpMap = Squad/Parts/FuelTank/RCSFuelTankR1/RCSFuelTankR1_N
			}
		}
		VARIANT
		{
			name = GrayAndWhite
			displayName = #autoLOC_8003112
			themeName = GrayAndWhite
			primaryColor = #ffffff
			secondaryColor = #adadad
			TEXTURE
			{
				mainTextureURL = Squad/Parts/FuelTank/RCSFuelTankR1/RCSFuelTankR1_01
				_BumpMap = Squad/Parts/FuelTank/RCSFuelTankR1/RCSFuelTankR1_N
			}
		}
	}
}

// fix the incorrect animations of the afterburning jet engine (IRL the nozzle would expand for afterburning, not contract)
// actually, forget this code. guess it's not broken after all?
//@PART[turboJet]:HAS[@MODULE[FXModuleAnimateThrottle]]:NEEDS[!Restock]:FOR[MunksFixes]
//{
//	@MODULE[FXModuleAnimateThrottle]:HAS[#engineName[Dry]]
//	{
//		@animationName = TurboJetNozzleWet
//	}
//	@MODULE[FXModuleAnimateThrottle]:HAS[#engineName[Wet]]
//	{
//		@animationName = TurboJetNozzleDry
//	}
//}


// restore the blinking light animation for the DTS-M1 antenna
@PART[mediumDishAntenna]:HAS[!MODULE[ModuleAnimateGeneric]]:NEEDS[!Restock]:FOR[MunksFixes]
{
	MODULE
	{
		name = ModuleAnimateGeneric
		animationName = pulseEmitMediumDishAntenna

		startEventGUIName = Blink Lights (Permanent)
		endEventGUIName = Blink Lights (Permanent)
		actionGUIName = Blink Lights (Permanent)

		eventAvailableEditor = false
		eventAvailableFlight = true
		allowManualControl = true
		isOneShot = false
	}
}


// fix some parts having too high of a gimbalResponseSpeed. uses the standard value of 8 used by the Restock team
@PART:HAS[@MODULE[ModuleGimbal]:HAS[#useGimbalResponseSpeed[?rue],#gimbalResponseSpeed[*]]]:LAST[MunksFixes]
{
	@MODULE[ModuleGimbal]		{	@gimbalResponseSpeed = 8	}
}

//fix engines with gimbals looking weird by giving them gimbalResponseSpeed
@PART:HAS[@MODULE[ModuleGimbal]:HAS[~useGimbalResponseSpeed[*]]]:LAST[MunksFixes]
{
	@MODULE[ModuleGimbal]
	{
		%gimbalResponseSpeed = 8
		%useGimbalResponseSpeed = true
	}
}

// nerfs the absolutely ridiculous shutdown temp of the stock RTG. this thing would never overheat in the stock game (and even now it still wouldn't overheat easily)
@PART[rtg]:HAS[@MODULE[ModuleCoreHeat]]:NEEDS[!SystemHeat]:FOR[MunksFixes]
{
	@MODULE[ModuleCoreHeat]		{	@CoreShutdownTemp *= 0.1	}	// 1000, lowered from 10000
}


// nerfs the *even more ridiculous* stress tolerance of the 3 stock landing legs. sets stressTolerance equal to their impactTolerance
//@PART[miniLandingLeg]:HAS[@MODULE[ModuleWheelDamage]]:FOR[MunksFixes]
//{
//	@MODULE[ModuleWheelDamage]	{	@stressTolerance = 40		}
//}
//@PART[landingLeg1]:HAS[@MODULE[ModuleWheelDamage]]:FOR[MunksFixes]
//{
//	@MODULE[ModuleWheelDamage]	{	@stressTolerance = 150		}
//}
//@PART[landingLeg1-2]:HAS[@MODULE[ModuleWheelDamage]]:FOR[MunksFixes]
//{
//	@MODULE[ModuleWheelDamage]	{	@stressTolerance = 600		}
//}


// make ec usage of the extra-large landing gear light consistent with the other landing gear (it isn't)
@PART[GearLarge]:HAS[@MODULE[ModuleLight]]:FOR[MunksFixes]
{
	@MODULE[ModuleLight]		{	@resourceAmount /= 0.75		}	// 0.04, raised from 0.03
}


// upgrade ModuleLight on the deprecated light parts. makes them slightly less useless in-game, if ever you wanted to use them over the newer models for some reason
// idk man maybe you're just feeling nostalgic. or have a vendetta against AlexanderM
@PART[spotLight1|spotLight2]:HAS[@MODULE[ModuleLight]]:FOR[MunksFixes]
{
	@MODULE[ModuleLight]
	{
		%canBlink = true
		%disableColorPicker = false
	}
}

// remove the broken ModuleFlagDecal on some engines. I'd fix them if i could, but alas, that is beyond my expertise
// if you're curious, the Flag Transform on the Size2LFB_v2 is just straight up missing, and on the Size3AdvancedEngine it doesn't even have a renderer
@PART[Size3AdvancedEngine|Size2LFB_v2]:HAS[@MODULE[FlagDecal]]:NEEDS[!Restock]:FOR[MunksFixes]
{	!MODULE[FlagDecal],* 			{}	}

// remove useless module (part has no animation components in its model)
// like why even bother giving it FXModuleAnimateThrottle if the model has no animation smh skwaud
@PART[liquidEngineMainsail_v2]:HAS[@MODULE[FXModuleAnimateThrottle]]:NEEDS[!Restock]:FOR[MunksFixes]
{	!MODULE[FXModuleAnimateThrottle],*	{}	}

// fix missing ConverterName on ModuleAsteriodDrill/ModuleCometDrill. for some reason, Squad just... forgot to give them proper titles???
@PART[MiniDrill|RadialDrill]:HAS[@MODULE[ModuleAsteroidDrill],@MODULE[ModuleCometDrill]]:FOR[MunksFixes]
{
	@MODULE[ModuleAsteroidDrill]	{	%ConverterName = #LOC_MunksFixes_asteriodHarvester	}	// Asteroid Harvester
	@MODULE[ModuleCometDrill]	{	%ConverterName = #LOC_MunksFixes_cometHarvester		}	// Comet Harvester
}


// fix the mk2 docking port not being able to rotate with Restock installed
@PART[mk2DockingPort]:HAS[@MODULE[ModuleDockingNode]:HAS[#canRotate[?rue]]]:NEEDS[Restock]:LAST[MunksFixes]
{
	@MODULE[ModuleDockingNode]	{	@rotationTransformName = port.001	}
}


// =========================================================================================================================================================
// DLC parts patches

// fix CoM and tweaks bottom stacking node for the MEM. written by @Errol, CoM values from by @RoboRay. tweaked (stolen) by @munktron239
@PART[MEMLander]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	%CoMOffset = 0.0, 0.6998, 0.029
	@node_stack_bottom2 = 0.0, -0.25, 0.0, 0, -1, 0, 1
}


// make the dlc fairings weight and costs consistent with the other fairings (they aren't). lowers the mass and increases the cost to match progression with the 3 stock fairings
@PART[fairingSize1p5]:HAS[@MODULE[ModuleProceduralFairing]]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	@MODULE[ModuleProceduralFairing]
	{
		@UnitAreaMass *= 0.75		// mass: now 0.01125, lowered from 0.015
		@UnitAreaCost *= 1.5		// cost: now 9, up from 6
	}
}
@PART[fairingSize4]:HAS[@MODULE[ModuleProceduralFairing]]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	@MODULE[ModuleProceduralFairing]
	{
		@UnitAreaMass *= 0.8		// mass: now 0.024, lowered from 0.03
		@UnitAreaCost /= 0.75		// cost: now 24, up from 18
	}
}


// fix 1.875m heatshield having too much lift. it's current lift is copied from the 2.5m heatshield (too much)
@PART[HeatShield1p5]:HAS[@MODULE[ModuleLiftingSurface]]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	@MODULE[ModuleLiftingSurface]	{	@deflectionLiftCoeff *= 0.75	}	// model is 0.75 scale, so multiply lift by 0.75
}


// gives Mk2 pod ModuleLifitingSurface, since the MK1 and Mk1-3 pod also have it. also fixes missing skinMaxTemp (idk how RoverDude forgot it)
@PART[Mk2Pod]:HAS[~skinMaxTemp[*],!MODULE[ModuleLiftingSurface]]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	@maxTemp = 1200
	%skinMaxTemp = 2200
	%CoLOffset = 0.0, -0.5, 0.0
	%bodyLiftOnlyUnattachedLift = True
	%bodyLiftOnlyAttachName = bottom
	MODULE
	{
		name = ModuleLiftingSurface
		useInternalDragModel = False
		deflectionLiftCoeff = 0.7		// between Mk1 pod (0.35) and Mk1-3 pod (1.4)
		liftingSurfaceCurve = CapsuleBottom
		disableBodyLift = False
		omnidirectional = False
		perpendicularOnly = True
		transformDir = Y
		transformSign = -1
		nodeEnabled = True
		attachNodeName = bottom
	}
}


// fix non-localized strings for the inflatable airlock. man, some of these MH parts are unfinished
@PART[InflatableAirlock]:HAS[@MODULE[ModuleScienceContainer]]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	@MODULE[ModuleScienceContainer]
	{
		@reviewActionName = #autoLOC_502201	//#autoLOC_502201 = Review Stored Data
		@storeActionName = #autoLOC_502202	//#autoLOC_502202 = Store Experiments
	}
}


// fix gimbal range not displaying correctly (the 'yMult = 0' parameter doesn't seem to work anyways)
@PART[LiquidEngineRV-1]:HAS[@MODULE[ModuleGimbal]]:NEEDS[SquadExpansion/MakingHistory]:FOR[MunksFixes]
{
	@MODULE[ModuleGimbal]
	{
		%gimbalRangeXP = 22.5
		%gimbalRangeXN = 22.5
		%gimbalRangeYP = 0
		%gimbalRangeYN = 0
	}
}

// =========================================================================================================================================================
// other mods parts patches

// make probe control point consistent on restock plus probes (they aren't)
@PART[restock-drone-core-0625-1|restock-drone-core-1875-1]:HAS[@MODULE[ModuleProbeControlPoint]:HAS[#multiHop[?rue]]]:NEEDS[Restockplus]:FOR[MunksFixes]
{
	@MODULE[ModuleProbeControlPoint]	{	@multiHop = false	}
}

// also make kerbnet FOV consistent between probecores (it isn't)
@PART[restock-drone-core-0625-1]:HAS[@MODULE[ModuleKerbNetAccess]]:NEEDS[Restockplus]:FOR[MunksFixes]
{
	@MODULE[ModuleKerbNetAccess]
	{
		@MinimumFoV = 9
		@MaximumFoV = 81
		@AnomalyDetection = 0.24
	}
}
